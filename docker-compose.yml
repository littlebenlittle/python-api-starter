version: '3'

services:

  grpc-api:
    build:
      context: ./api/grpc
    volumes:
    - './api/grpc:/app'
    - '${HOME}/.secrets/local_testing.json:/secrets/client_secrets.json'
    environment:
    - 'VAULT_ADDR=http://vault:8200'
    - 'VAULT_TOKEN=abc123'
    - 'CLIENT_SECRETS_FILE=/secrets/client_secrets.json'
    - 'OAUTH2_SCOPES=https://www.googleapis.com/auth/drive.metadata.readonly'
    - 'PYTHON_PB=/python_pb'
    networks:
    - default
    command: sleep 3600

  http-api:
    build:
      context: ./api/http
    volumes:
    - './api/http:/app'
    - '${HOME}/.certs/localhost.crt:/etc/ssl/certs/localhost.crt'
    - '${HOME}/.certs/localhost.key:/etc/ssl/private/localhost.key'
    environment:
    - 'REDIRECT_URI=https://localhost:4443/redirect'
    - 'TLSCERT=/etc/ssl/certs/localhost.crt'
    - 'TLSKEY=/etc/ssl/private/localhost.key'

  web: 
    build:
      context: ./web
    volumes:
    - './web:/app'
    - '${HOME}/.certs/localhost.crt:/etc/ssl/certs/localhost.crt'
    - '${HOME}/.certs/localhost.key:/etc/ssl/private/localhost.key'
    - '${HOME}/.secrets/local_testing.json:/secrets/client_secrets.json'
    environment:
    - 'SCOPES=https://www.googleapis.com/auth/drive.metadata.readonly'
    - 'TLSCERT=/etc/ssl/certs/localhost.crt'
    - 'TLSKEY=/etc/ssl/private/localhost.key'
    networks:
    - default
    ports:
    - '4443:443'

  vault:
    image: vault:1.2.3
    networks:
    - default
    ports:
    - '8200:8200'
    environment:
    - 'VAULT_DEV_ROOT_TOKEN_ID=abc123'
    cap_add:
    - IPC_LOCK
